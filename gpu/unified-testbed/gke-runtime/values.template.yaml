# Copyright 2025 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# =============================================================================
# Unified Testbed Helm Chart Values - 模板文件
# =============================================================================
# 使用说明:
#   1. 复制此文件为 values.yaml: cp values.template.yaml values.yaml
#   2. 修改下方 <YOUR_...> 占位符为您的实际值
#   3. values.yaml 已加入 .gitignore，不会被提交到版本控制
# =============================================================================

# -----------------------------------------------------------------------------
# Kueue 队列配置
# -----------------------------------------------------------------------------
queue: # 留空表示不使用 Kueue 队列调度

# DWS (Dynamic Workload Scheduler) 设置
dwsSettings:
  maxRunDurationSeconds: # 最大运行时长（秒），留空表示不限制

# TAS (Topology Aware Scheduling) 设置
tasSettings:
  topologyRequest:
    kueue.x-k8s.io/podset-preferred-topology: "cloud.google.com/gce-topology-block"

# -----------------------------------------------------------------------------
# 存储卷配置
# -----------------------------------------------------------------------------
volumes:
  # GCS 存储卷开关
  gcsVolumes: true

  # 本地 SSD 挂载路径
  ssdMountPath: "/ssd"

  # NFS 共享存储配置 (Filestore)
  nfs:
    enabled: false # 是否启用 NFS
    ip: "<YOUR_FILESTORE_IP>" # Filestore IP 地址，如 10.x.x.x
    volume: "<YOUR_VOLUME_NAME>" # 卷名称，如 nfslarge
    region: "<YOUR_ZONE>" # 区域，如 asia-southeast1-b
    instance: "<YOUR_FILESTORE_INSTANCE>" # Filestore 实例名
    storage: "10Ti" # 存储容量
    mountPath: "/mnt/nfs" # 容器内挂载路径

  # Managed Lustre 存储配置
  # 参考: https://cloud.google.com/kubernetes-engine/docs/how-to/persistent-volumes/cloud-lustre-csi-driver
  # 挂载点格式: IP@tcp:/filesystem (例如: 172.27.48.5@tcp:/lustrefs)
  lustre:
    enabled: false # 是否启用 Lustre
    ip: "<YOUR_LUSTRE_IP>" # Lustre 实例 IP
    filesystem: "lustrefs" # 文件系统名称
    instanceName: "<YOUR_LUSTRE_INSTANCE>" # Lustre 实例名称
    projectId: "<YOUR_PROJECT_ID>" # Google Cloud 项目 ID
    location: "<YOUR_ZONE>" # 可用区
    storage: "9000Gi" # 存储容量
    storageClassName: "" # StorageClass 名称 (留空使用默认)
    mountPath: "/mnt/lustrefs" # 容器内挂载路径

  # PVC 挂载配置（NFS 启用时自动配置，不需要手动设置）
  pvcMounts: []

  # GCS Bucket 挂载配置
  gcsMounts:
    - bucketName: <YOUR_GCS_BUCKET> # 您的 GCS 存储桶
      mountPath: "/gcs"
      mountOptions: "implicit-dirs"
    - bucketName: cloud-samples-data # 公共示例数据桶
      mountPath: "/artifacts"
      mountOptions: "implicit-dirs"

# -----------------------------------------------------------------------------
# 工作负载配置
# -----------------------------------------------------------------------------
workload:
  # GPU 数量（必须是 8 的倍数或 <= 8）
  gpus: 16

  # 容器镜像
  # Artifact Registry 格式：
  #   多区域: asia-docker.pkg.dev, us-docker.pkg.dev, europe-docker.pkg.dev
  #   单区域: us-central1-docker.pkg.dev, asia-southeast1-docker.pkg.dev
  image: "<YOUR_AR_LOCATION>-docker.pkg.dev/<YOUR_PROJECT_ID>/<YOUR_REPO>/unified-testbed-pytorch:25.06-py3"

  # 最大重启次数
  max_workload_restarts: 0

  # 默认启动参数
  defaultArguments: []

  # 额外启动参数
  arguments: []

  # 配置文件名称（可选）
  configFile: ""

  # 配置文件路径
  configPath: /workload/configs

  # 工作流控制开关
  workflow:
    enabled: false # 是否启用工作流模式
    skipCloneRepo: false # 跳过代码克隆
    skipDownloadData: false # 跳过数据下载
    skipCheckpointConversion: false # 跳过检查点转换
    skipTraining: false # 跳过训练

  # 调试模式：保持容器运行（设为 false 时运行完测试脚本后退出）
  sleepInfinity: true

  # 环境变量
  envs:
    # SSH 公钥（用于从本地机器远程 SSH 进入 Pod 调试）
    # 生成方式: ssh-keygen -t rsa -b 4096 -f ~/.ssh/my-gke-key
    # 然后将 ~/.ssh/my-gke-key.pub 的内容粘贴到这里
    - name: SSH_PUBLIC_KEY
      value: "<YOUR_SSH_PUBLIC_KEY>"

    # HuggingFace Token（用于模型下载）
    # 获取方式: https://huggingface.co/settings/tokens
    - name: HF_TOKEN
      value: "<YOUR_HF_TOKEN>"

    # NeMo/Megatron 相关配置
    - name: NVTE_FWD_LAYERNORM_SM_MARGIN
      value: "8"
    - name: NVTE_BWD_LAYERNORM_SM_MARGIN
      value: "8"
    - name: GLOO_SOCKET_IFNAME
      value: "eth0"
    - name: TORCH_DISTRIBUTED_TRACING
      value: "ALL"

    # 工作流环境变量（根据存储类型设置）
    # Lustre: /mnt/lustrefs, NFS: /mnt/nfs
    - name: PAI_WORKSPACE_ROOT
      value: "/mnt/lustrefs"

# -----------------------------------------------------------------------------
# 网络配置
# -----------------------------------------------------------------------------
network:
  # 使用主机网络模式（A4 推荐开启）
  hostNetwork: true

  # GIB (Google InfiniBand) 插件镜像
  gibVersion: us-docker.pkg.dev/gce-ai-infra/gpudirect-gib/nccl-plugin-gib-diagnostic:latest

  # 自定义子网络列表（可选）
  subnetworks: []

  # NCCL 通信设置
  ncclSettings:
    - name: NCCL_DEBUG
      value: "WARN"
    - name: NVTE_UB_SOCKET_IFNAME
      value: "eth1"

# -----------------------------------------------------------------------------
# 节点选择配置（可选）
# -----------------------------------------------------------------------------

# 指定目标节点（调度到这些节点）
targetNodes: []
# 示例:
# targetNodes:
# - gke-cluster-a4-node-pool-1234abcd

# 避免的节点（不调度到这些节点）
avoidNodes: []
# 示例:
# avoidNodes:
# - gke-cluster-a4-node-pool-5678efgh
