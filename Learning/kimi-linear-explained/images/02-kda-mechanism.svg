<?xml version="1.0" encoding="UTF-8"?>
<svg width="900" height="600" viewBox="0 0 900 600" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="blueGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea"/>
      <stop offset="100%" style="stop-color:#764ba2"/>
    </linearGradient>
    <linearGradient id="greenGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#48bb78"/>
      <stop offset="100%" style="stop-color:#38a169"/>
    </linearGradient>
    <linearGradient id="orangeGrad2" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#ed8936"/>
      <stop offset="100%" style="stop-color:#dd6b20"/>
    </linearGradient>
    <linearGradient id="pinkGrad" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#ed64a6"/>
      <stop offset="100%" style="stop-color:#d53f8c"/>
    </linearGradient>
    <filter id="shadow2" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="2" dy="2" stdDeviation="3" flood-opacity="0.2"/>
    </filter>
    <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
      <polygon points="0 0, 10 3.5, 0 7" fill="#333"/>
    </marker>
  </defs>
  
  <!-- 标题 -->
  <text x="450" y="35" font-family="Arial, sans-serif" font-size="22" font-weight="bold" fill="#333" text-anchor="middle">Kimi Delta Attention (KDA) 机制详解</text>
  <text x="450" y="60" font-family="Arial, sans-serif" font-size="13" fill="#666" text-anchor="middle">在 Gated DeltaNet 基础上引入细粒度通道级遗忘门</text>
  
  <!-- 左侧: 输入处理 -->
  <rect x="30" y="90" width="250" height="480" rx="15" fill="#f8f9fa" stroke="#e2e8f0" stroke-width="2"/>
  <text x="155" y="120" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#333" text-anchor="middle">输入处理</text>
  
  <!-- x_t 输入 -->
  <rect x="90" y="140" width="130" height="40" rx="8" fill="url(#orangeGrad2)" filter="url(#shadow2)"/>
  <text x="155" y="165" font-family="Arial, sans-serif" font-size="13" fill="white" text-anchor="middle">x_t (输入向量)</text>
  
  <!-- 分支箭头 -->
  <path d="M155 180 L155 200 L65 200 L65 240" stroke="#333" stroke-width="2" fill="none"/>
  <path d="M155 180 L155 200 L155 240" stroke="#333" stroke-width="2" fill="none"/>
  <path d="M155 180 L155 200 L245 200 L245 240" stroke="#333" stroke-width="2" fill="none"/>
  
  <!-- q, k, v 生成 -->
  <rect x="40" y="240" width="50" height="60" rx="6" fill="url(#blueGrad2)" filter="url(#shadow2)"/>
  <text x="65" y="265" font-family="Arial, sans-serif" font-size="11" fill="white" text-anchor="middle">Linear</text>
  <text x="65" y="280" font-family="Arial, sans-serif" font-size="11" fill="white" text-anchor="middle">Conv</text>
  <text x="65" y="295" font-family="Arial, sans-serif" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">L2Norm</text>
  
  <rect x="130" y="240" width="50" height="60" rx="6" fill="url(#blueGrad2)" filter="url(#shadow2)"/>
  <text x="155" y="265" font-family="Arial, sans-serif" font-size="11" fill="white" text-anchor="middle">Linear</text>
  <text x="155" y="280" font-family="Arial, sans-serif" font-size="11" fill="white" text-anchor="middle">Conv</text>
  <text x="155" y="295" font-family="Arial, sans-serif" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">L2Norm</text>
  
  <rect x="220" y="240" width="50" height="60" rx="6" fill="url(#greenGrad2)" filter="url(#shadow2)"/>
  <text x="245" y="265" font-family="Arial, sans-serif" font-size="11" fill="white" text-anchor="middle">Linear</text>
  <text x="245" y="280" font-family="Arial, sans-serif" font-size="11" fill="white" text-anchor="middle">Conv</text>
  <text x="245" y="295" font-family="Arial, sans-serif" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">Swish</text>
  
  <!-- 输出标签 -->
  <text x="65" y="320" font-family="Arial, sans-serif" font-size="13" fill="#667eea" text-anchor="middle" font-weight="bold">q</text>
  <text x="155" y="320" font-family="Arial, sans-serif" font-size="13" fill="#667eea" text-anchor="middle" font-weight="bold">k</text>
  <text x="245" y="320" font-family="Arial, sans-serif" font-size="13" fill="#38a169" text-anchor="middle" font-weight="bold">v</text>
  
  <!-- 遗忘门分支 -->
  <path d="M155 185 L155 360" stroke="#333" stroke-width="1" stroke-dasharray="4,4" fill="none"/>
  
  <rect x="50" y="360" width="90" height="50" rx="6" fill="url(#pinkGrad)" filter="url(#shadow2)"/>
  <text x="95" y="382" font-family="Arial, sans-serif" font-size="11" fill="white" text-anchor="middle">低秩投影</text>
  <text x="95" y="398" font-family="Arial, sans-serif" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">W↓ → W↑</text>
  
  <rect x="170" y="360" width="90" height="50" rx="6" fill="url(#orangeGrad2)" filter="url(#shadow2)"/>
  <text x="215" y="382" font-family="Arial, sans-serif" font-size="11" fill="white" text-anchor="middle">Sigmoid</text>
  <text x="215" y="398" font-family="Arial, sans-serif" font-size="10" fill="rgba(255,255,255,0.8)" text-anchor="middle">→ β_t</text>
  
  <text x="95" y="430" font-family="Arial, sans-serif" font-size="13" fill="#d53f8c" text-anchor="middle" font-weight="bold">α_t (通道级)</text>
  <text x="215" y="430" font-family="Arial, sans-serif" font-size="13" fill="#dd6b20" text-anchor="middle" font-weight="bold">β_t (标量)</text>
  
  <!-- 中间: 核心机制 -->
  <rect x="310" y="90" width="280" height="480" rx="15" fill="#f0fff4" stroke="#c6f6d5" stroke-width="2"/>
  <text x="450" y="120" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#333" text-anchor="middle">KDA 核心更新公式</text>
  
  <!-- 公式框 -->
  <rect x="330" y="140" width="240" height="100" rx="10" fill="white" stroke="#48bb78" stroke-width="2"/>
  <text x="450" y="170" font-family="Arial, sans-serif" font-size="14" fill="#333" text-anchor="middle" font-weight="bold">状态更新:</text>
  <text x="450" y="195" font-family="monospace" font-size="12" fill="#333" text-anchor="middle">S_t = (I - β_t·k_t·k_t^T)</text>
  <text x="450" y="215" font-family="monospace" font-size="12" fill="#333" text-anchor="middle">× Diag(α_t) × S_{t-1}</text>
  <text x="450" y="235" font-family="monospace" font-size="12" fill="#333" text-anchor="middle">+ β_t · k_t · v_t^T</text>
  
  <!-- 对比框 -->
  <rect x="330" y="260" width="240" height="140" rx="10" fill="white" stroke="#ddd" stroke-width="2"/>
  <text x="450" y="285" font-family="Arial, sans-serif" font-size="13" font-weight="bold" fill="#666" text-anchor="middle">vs. Gated DeltaNet (标量门)</text>
  <text x="450" y="310" font-family="monospace" font-size="11" fill="#999" text-anchor="middle">S_t = α_t · (I - β_t·k_t·k_t^T)</text>
  <text x="450" y="330" font-family="monospace" font-size="11" fill="#999" text-anchor="middle">× S_{t-1} + β_t · k_t · v_t^T</text>
  <line x1="350" y1="355" x2="550" y2="355" stroke="#ddd" stroke-width="1"/>
  <text x="450" y="380" font-family="Arial, sans-serif" font-size="12" fill="#48bb78" text-anchor="middle">🎯 KDA: 每个特征维度有独立遗忘率</text>
  
  <!-- 输出门 -->
  <rect x="330" y="420" width="240" height="60" rx="10" fill="url(#blueGrad2)" filter="url(#shadow2)"/>
  <text x="450" y="445" font-family="Arial, sans-serif" font-size="13" fill="white" text-anchor="middle" font-weight="bold">输出门</text>
  <text x="450" y="465" font-family="Arial, sans-serif" font-size="11" fill="rgba(255,255,255,0.8)" text-anchor="middle">Sigmoid(W_g · x) ⊙ RMSNorm(o)</text>
  
  <!-- 输出 -->
  <rect x="380" y="510" width="140" height="40" rx="8" fill="url(#greenGrad2)" filter="url(#shadow2)"/>
  <text x="450" y="535" font-family="Arial, sans-serif" font-size="13" fill="white" text-anchor="middle">KDA 输出</text>
  
  <!-- 右侧: 优势 -->
  <rect x="620" y="90" width="250" height="480" rx="15" fill="#fff5f5" stroke="#fed7d7" stroke-width="2"/>
  <text x="745" y="120" font-family="Arial, sans-serif" font-size="16" font-weight="bold" fill="#333" text-anchor="middle">KDA 优势</text>
  
  <!-- 优势列表 -->
  <rect x="640" y="140" width="210" height="80" rx="8" fill="white" stroke="#fc8181" stroke-width="2"/>
  <text x="660" y="165" font-family="Arial, sans-serif" font-size="13" fill="#333" font-weight="bold">🎯 细粒度记忆控制</text>
  <text x="660" y="185" font-family="Arial, sans-serif" font-size="11" fill="#666">每个特征维度独立遗忘</text>
  <text x="660" y="202" font-family="Arial, sans-serif" font-size="11" fill="#666">类似 RoPE 的位置编码效果</text>
  
  <rect x="640" y="235" width="210" height="80" rx="8" fill="white" stroke="#fc8181" stroke-width="2"/>
  <text x="660" y="260" font-family="Arial, sans-serif" font-size="13" fill="#333" font-weight="bold">⚡ 硬件高效</text>
  <text x="660" y="280" font-family="Arial, sans-serif" font-size="11" fill="#666">比通用 DPLR 快 ~2×</text>
  <text x="660" y="297" font-family="Arial, sans-serif" font-size="11" fill="#666">减少 3 个矩阵乘法运算</text>
  
  <rect x="640" y="330" width="210" height="80" rx="8" fill="white" stroke="#fc8181" stroke-width="2"/>
  <text x="660" y="355" font-family="Arial, sans-serif" font-size="13" fill="#333" font-weight="bold">🔄 Delta Rule</text>
  <text x="660" y="375" font-family="Arial, sans-serif" font-size="11" fill="#666">基于梯度下降的记忆更新</text>
  <text x="660" y="392" font-family="Arial, sans-serif" font-size="11" fill="#666">精确纠正 k→v 映射</text>
  
  <rect x="640" y="425" width="210" height="80" rx="8" fill="white" stroke="#fc8181" stroke-width="2"/>
  <text x="660" y="450" font-family="Arial, sans-serif" font-size="13" fill="#333" font-weight="bold">📊 合成任务表现</text>
  <text x="660" y="470" font-family="Arial, sans-serif" font-size="11" fill="#666">Palindrome, MQAR, Stack</text>
  <text x="660" y="487" font-family="Arial, sans-serif" font-size="11" fill="#666">收敛更快，精度更高</text>
  
  <!-- 连接线 -->
  <path d="M280 270 L310 270" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
  <path d="M590 450 L620 450" stroke="#333" stroke-width="2" marker-end="url(#arrowhead)"/>
</svg>
