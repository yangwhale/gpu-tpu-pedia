# DeepCache æ·±åº¦ç¼“å­˜åŠ é€ŸåŸç†è¯¦è§£

## æ¦‚è¿°

DeepCache æ˜¯ä¸€ç§ç”¨äºåŠ é€Ÿæ‰©æ•£æ¨¡å‹æ¨ç†çš„æŠ€æœ¯ï¼Œé€šè¿‡**å¤ç”¨ Transformer ä¸­é—´å±‚çš„ç¼“å­˜è¾“å‡º**æ¥è·³è¿‡é‡å¤è®¡ç®—ã€‚åœ¨ HunyuanVideo 1.5 ä¸Šå®æµ‹å¯è¾¾ **1.83x åŠ é€Ÿ**ï¼Œä¸”è´¨é‡æŸå¤±æå°ã€‚

## æ ¸å¿ƒåˆ›æ–°ç‚¹

### 1. è§‚å¯Ÿåˆ°çš„å…³é”®æ´å¯Ÿ

æ‰©æ•£æ¨¡å‹çš„ denoising è¿‡ç¨‹ä¸­ï¼Œç›¸é‚» timestep ä¹‹é—´çš„ä¸­é—´ç‰¹å¾å˜åŒ–æ˜¯**æ¸è¿›çš„ã€ç¼“æ…¢çš„**ï¼š

```
timestep t:   x_t â†’ Block_0 â†’ Block_1 â†’ ... â†’ Block_52 â†’ noise_pred_t
timestep t-1: x_t-1 â†’ Block_0 â†’ Block_1 â†’ ... â†’ Block_52 â†’ noise_pred_t-1
                      â†‘         â†‘                â†‘
                    ç›¸ä¼¼!     ç›¸ä¼¼!            ç›¸ä¼¼!
```

ç”±äº x_t å’Œ x_{t-1} å·®å¼‚å¾ˆå°ï¼Œä¸­é—´å±‚çš„è¾“å‡ºä¹Ÿéå¸¸ç›¸ä¼¼ã€‚**æ—¢ç„¶å¦‚æ­¤ï¼Œä¸ºä»€ä¹ˆè¿˜è¦é‡å¤è®¡ç®—å‘¢ï¼Ÿ**

### 2. DeepCache çš„è§£å†³æ–¹æ¡ˆ

**ç›´æ¥å¤ç”¨ä¸Šä¸€æ­¥çš„ä¸­é—´å±‚è¾“å‡ºï¼**

```python
def wrapped_forward(*args, **kwargs):
    if should_use_cache:  # åˆ¤æ–­æ˜¯å¦ä½¿ç”¨ç¼“å­˜
        result = self.cached_output[block_id]  # ç›´æ¥è¿”å›ç¼“å­˜
    else:
        result = original_forward(*args, **kwargs)  # æ­£å¸¸è®¡ç®—
        self.cached_output[block_id] = result  # ä¿å­˜åˆ°ç¼“å­˜
    return result
```

## å®ç°åŸç†å›¾è§£

### 50 æ­¥ Denoising å…¨æµç¨‹

ä»¥ HunyuanVideo 1.5 é»˜è®¤é…ç½®ä¸ºä¾‹ (`cache_start_step=11, cache_end_step=45, cache_step_interval=4`)ï¼š

```
Step:  0  1  2  3  4  5  6  7  8  9 10 | 11 12 13 14 | 15 16 17 18 | 19 ... | 45 46 47 48 49
       â”œâ”€â”€â”€â”€â”€â”€â”€â”€ å‰æœŸé˜¶æ®µ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”œâ”€ å‘¨æœŸ1 â”€â”€â”€â”€â”¤â”œâ”€ å‘¨æœŸ2 â”€â”€â”€â”€â”¤        â”œâ”€â”€ åæœŸé˜¶æ®µ â”€â”€â”¤
       â”‚         ä¸ä½¿ç”¨ Cache          â”‚â”‚ C  S  S  S â”‚â”‚ C  S  S  S â”‚  ...   â”‚  ä¸ä½¿ç”¨ Cache â”‚
       â”‚         (ä¿è¯è´¨é‡)            â”‚â”‚ è®¡ è·³ è·³ è·³â”‚â”‚ è®¡ è·³ è·³ è·³â”‚        â”‚  (ä¿è¯æ”¶æ•›)   â”‚
                                         â†‘ç®—  è¿‡  è¿‡  è¿‡  â†‘ç®—  è¿‡  è¿‡  è¿‡

C = è®¡ç®— (Compute) - æ­£å¸¸æ‰§è¡Œæ‰€æœ‰ 53 ä¸ª blockï¼Œå¹¶ç¼“å­˜æ¯ä¸ª block çš„è¾“å‡º
S = è·³è¿‡ (Skip)    - Block 0-51 ä½¿ç”¨ç¼“å­˜è¾“å‡ºï¼Œåªæœ‰ Block 52 æ­£å¸¸è®¡ç®—
```

### ğŸ”‘ å…³é”®ç†è§£ï¼š53 ä¸ª Block æ˜¯é¡ºåºæ‰§è¡Œçš„

HunyuanVideo 1.5 çš„ Transformer ç»“æ„ï¼š

```
latent_t â”€â”€â–º Block_0 â”€â”€â–º Block_1 â”€â”€â–º ... â”€â”€â–º Block_51 â”€â”€â–º Block_52 â”€â”€â–º noise_pred
              â”‚           â”‚                    â”‚            â”‚
           è¾“å‡º out_0   è¾“å‡º out_1          è¾“å‡º out_51   è¾“å‡º = noise_pred
```

**æ¯ä¸ª block çš„è¾“å…¥æ˜¯ä¸Šä¸€ä¸ª block çš„è¾“å‡º**ï¼Œæ‰€ä»¥å³ä½¿è¦è·³è¿‡è®¡ç®—ï¼Œä¹Ÿéœ€è¦çŸ¥é“ä¸Šä¸€æ­¥çš„è¾“å‡ºæ˜¯ä»€ä¹ˆ â†’ **å¿…é¡»ç¼“å­˜**

### å•æ­¥å†…éƒ¨æ‰§è¡Œæµç¨‹

#### ç¬¬ 11 æ­¥ï¼šæ­£å¸¸è®¡ç®—ï¼ˆå¡«å……ç¼“å­˜ï¼‰

```
                        53 ä¸ª Block é¡ºåºæ‰§è¡Œ
                        â†“
latent_11 â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â”‚                                                                   â”‚
            â–¼                                                                   â”‚
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
     â”‚ Block 0  â”‚      â”‚ Block 1  â”‚            â”‚ Block 51 â”‚      â”‚ Block 52 â”‚  â”‚
     â”‚          â”‚â”€â”€â”€â”€â”€â”€â”‚          â”‚â”€â”€ ... â”€â”€â”€â”€â”€â”‚          â”‚â”€â”€â”€â”€â”€â”€â”‚          â”‚â”€â”€â”¼â”€â”€â–º noise_pred_11
     â”‚ æ­£å¸¸è®¡ç®— â”‚      â”‚ æ­£å¸¸è®¡ç®— â”‚            â”‚ æ­£å¸¸è®¡ç®— â”‚      â”‚ æ­£å¸¸è®¡ç®— â”‚  â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜  â”‚
          â”‚                 â”‚                       â”‚                 â”‚         â”‚
          â–¼                 â–¼                       â–¼                 â–¼         â”‚
      cache[0]          cache[1]              cache[51]          cache[52]     â”‚
      ä¿å­˜ out_0        ä¿å­˜ out_1            ä¿å­˜ out_51        (ä¸ç¼“å­˜)       â”‚
                                                                               â”‚
è®¡ç®—é‡: 100% (53 ä¸ª block å…¨éƒ¨æ‰§è¡Œ)                                             â”‚
æ—¶é—´:   ~5.2 ç§’                                                                 â”‚
```

#### ç¬¬ 12 æ­¥ï¼šä½¿ç”¨ç¼“å­˜ï¼ˆè·³è¿‡ Block 0-51ï¼‰

**å…³é”®ç‚¹ï¼šç¬¬ 12 æ­¥çš„ latent_12 è·Ÿç¬¬ 11 æ­¥çš„ latent_11 æ˜¯ä¸åŒçš„ï¼**
ä½†æ˜¯ Block 0-51 ç›´æ¥è¿”å›ä¸Šæ¬¡ç¼“å­˜çš„è¾“å‡ºï¼Œ**å®Œå…¨å¿½ç•¥æ–°çš„è¾“å…¥**ã€‚

```
latent_12 â”€â”€â”  (æ–°çš„è¾“å…¥ï¼Œä½†è¢«å¿½ç•¥ï¼)
            â”‚
            â–¼
     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚ Block 0  â”‚      â”‚ Block 1  â”‚            â”‚ Block 51 â”‚      â”‚ Block 52 â”‚
     â”‚          â”‚â”€â”€â”€â”€â”€â”€â”‚          â”‚â”€â”€ ... â”€â”€â”€â”€â”€â”‚          â”‚â”€â”€â”€â”€â”€â”€â”‚          â”‚â”€â”€â–º noise_pred_12
     â”‚  SKIP!   â”‚      â”‚  SKIP!   â”‚            â”‚  SKIP!   â”‚      â”‚ æ­£å¸¸è®¡ç®— â”‚
     â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜            â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”˜
          â”‚                 â”‚                       â”‚                 â”‚
          â–¼                 â–¼                       â–¼                 â”‚
    è¿”å› cache[0]     è¿”å› cache[1]          è¿”å› cache[51]          â”‚
    (ç¬¬11æ­¥çš„out_0)  (ç¬¬11æ­¥çš„out_1)        (ç¬¬11æ­¥çš„out_51)          â”‚
                                                    â”‚                 â”‚
                                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–ºâ”‚
                                                  Block 52 çš„è¾“å…¥      â”‚
                                                  æ¥è‡ªç¼“å­˜ï¼           â”‚
                                                                       
è®¡ç®—é‡: ~2% (åªæ‰§è¡Œ Block 52)
æ—¶é—´:   ~0.1 ç§’
```

### ç¬¬ 12, 13, 14 æ­¥éƒ½ç”¨ç¬¬ 11 æ­¥çš„ç¼“å­˜å—ï¼Ÿ

**æ˜¯çš„ï¼** è¿™å°±æ˜¯ DeepCache çš„æ ¸å¿ƒè®¾è®¡ï¼š

```
Step 11: æ­£å¸¸è®¡ç®— â†’ å¡«å…… cache[0] ~ cache[51]
Step 12: ä½¿ç”¨ cache[0~51] â†’ åªè®¡ç®— Block 52 â†’ noise_pred_12
Step 13: ä½¿ç”¨ cache[0~51] â†’ åªè®¡ç®— Block 52 â†’ noise_pred_13
Step 14: ä½¿ç”¨ cache[0~51] â†’ åªè®¡ç®— Block 52 â†’ noise_pred_14
Step 15: æ­£å¸¸è®¡ç®— â†’ æ›´æ–° cache[0] ~ cache[51]  â† åˆ·æ–°ç¼“å­˜
Step 16: ä½¿ç”¨æ–°çš„ cache[0~51] â†’ åªè®¡ç®— Block 52 â†’ ...
```

### ä¸ºä»€ä¹ˆ Block 52 å¿…é¡»æ­£å¸¸è®¡ç®—ï¼Ÿ

è™½ç„¶ Block 52 çš„è¾“å…¥ï¼ˆæ¥è‡ª cache[51]ï¼‰æ˜¯å›ºå®šçš„ï¼Œä½† **Block 52 è¿˜æœ‰å…¶ä»–è¾“å…¥**ï¼š

```python
# Transformer Block çš„è¾“å…¥åŒ…æ‹¬ï¼š
def forward(
    self,
    hidden_states,      # æ¥è‡ªä¸Šä¸€ä¸ª block çš„è¾“å‡ºï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰
    timestep,           # å½“å‰ timestepï¼ˆæ¯æ­¥ä¸åŒï¼ï¼‰
    text_embeds,        # æ–‡æœ¬ embedding
    ...
):
```

**timestep æ˜¯å…³é”®**ï¼è™½ç„¶ hidden_states æ¥è‡ªç¼“å­˜ï¼Œä½†ï¼š
- ç¬¬ 12 æ­¥ï¼štimestep = 0.78
- ç¬¬ 13 æ­¥ï¼štimestep = 0.76
- ç¬¬ 14 æ­¥ï¼štimestep = 0.74

ä¸åŒçš„ timestep ä¼šäº§ç”Ÿä¸åŒçš„ noise_predï¼Œè¿™å°±æ˜¯ä¸ºä»€ä¹ˆå³ä½¿è¾“å…¥ç›¸åŒï¼ŒBlock 52 ä¹Ÿå¿…é¡»é‡æ–°è®¡ç®—ã€‚

### ä¸ºä»€ä¹ˆ Block 0-51 å¯ä»¥å¿½ç•¥æ–°è¾“å…¥ï¼Ÿ

è¿™æ˜¯ DeepCache çš„**æ ¸å¿ƒå‡è®¾**ï¼š

> **ç›¸é‚» timestep ä¹‹é—´ï¼Œä¸­é—´å±‚çš„ç‰¹å¾å˜åŒ–å¾ˆå°ï¼Œå¯ä»¥è¿‘ä¼¼è®¤ä¸ºç›¸ç­‰ã€‚**

è™½ç„¶ latent_12 â‰  latent_11ï¼Œä½†ï¼š
```
Block_0(latent_12) â‰ˆ Block_0(latent_11) = cache[0]
```

è¿™ä¸ªè¿‘ä¼¼åœ¨æ‰©æ•£æ¨¡å‹ä¸­æ˜¯æˆç«‹çš„ï¼Œå› ä¸ºï¼š
1. scheduler è®¾è®¡ä½¿å¾—ç›¸é‚»æ­¥éª¤çš„ latent å˜åŒ–å¾ˆå°
2. Transformer block æ˜¯è¿ç»­å‡½æ•°ï¼Œè¾“å…¥å°å˜åŒ– â†’ è¾“å‡ºå°å˜åŒ–
3. è¯¯å·®åœ¨æœ€åä¸€å±‚è¢«"ä¿®æ­£"ï¼ˆå› ä¸º Block 52 æ­£å¸¸è®¡ç®—ï¼‰

### å®Œæ•´çš„æ•°æ®æµå¯¹æ¯”

#### æ— ç¼“å­˜ï¼ˆæ­£å¸¸æ‰§è¡Œï¼‰

```
Step 11:
  latent_11 â”€â”€â”€â–º Block_0 â”€â”€â”€â–º Block_1 â”€â”€â”€â–º ... â”€â”€â”€â–º Block_51 â”€â”€â”€â–º Block_52 â”€â”€â”€â–º noise_pred_11
                   â”‚           â”‚                      â”‚              â”‚
                   â”‚ out_0     â”‚ out_1                â”‚ out_51       â”‚ (ç›´æ¥è¾“å‡º)
                   â–¼           â–¼                      â–¼
              [å­˜å…¥cache]  [å­˜å…¥cache]           [å­˜å…¥cache]
              
Step 12:
  latent_12 â”€â”€â”€â–º Block_0 â”€â”€â”€â–º Block_1 â”€â”€â”€â–º ... â”€â”€â”€â–º Block_51 â”€â”€â”€â–º Block_52 â”€â”€â”€â–º noise_pred_12
                   â”‚           â”‚                      â”‚              â”‚
                   â”‚ out_0'    â”‚ out_1'               â”‚ out_51'      â”‚ (ç›´æ¥è¾“å‡º)
                   â–¼           â–¼                      â–¼
              (ä¸ä¿å­˜)     (ä¸ä¿å­˜)              (ä¸ä¿å­˜)

è®¡ç®—é‡: Step 11 = 100%, Step 12 = 100%
```

#### æœ‰ç¼“å­˜ï¼ˆDeepCacheï¼‰

```
Step 11 (å¡«å……ç¼“å­˜):
  latent_11 â”€â”€â”€â–º Block_0 â”€â”€â”€â–º Block_1 â”€â”€â”€â–º ... â”€â”€â”€â–º Block_51 â”€â”€â”€â–º Block_52 â”€â”€â”€â–º noise_pred_11
                   â”‚           â”‚                      â”‚              â”‚
                   â”‚ out_0     â”‚ out_1                â”‚ out_51       â”‚ (ç›´æ¥è¾“å‡º)
                   â–¼           â–¼                      â–¼
              cache[0]    cache[1]              cache[51]

Step 12 (ä½¿ç”¨ç¼“å­˜):
  latent_12 â”€â”€â”€â”
               â”‚
               â–¼ (è¢«å¿½ç•¥ï¼)
            Block_0 â”€â”€â”€â–º Block_1 â”€â”€â”€â–º ... â”€â”€â”€â–º Block_51 â”€â”€â”€â–º Block_52 â”€â”€â”€â–º noise_pred_12
               â”‚           â”‚                      â”‚              â”‚
               â”‚           â”‚                      â”‚              â”‚ (æ­£å¸¸è®¡ç®—)
               â–¼           â–¼                      â–¼
           è¿”å›cache[0] è¿”å›cache[1]        è¿”å›cache[51] â”€â”€â”€â”€â”€â”€â”€â”€â”˜
           (ä¸è®¡ç®—)    (ä¸è®¡ç®—)             (ä¸è®¡ç®—)           â†‘
                                                            Block_52 ä½¿ç”¨
                                                            cache[51] + timestep_12
                                                            æ¥è®¡ç®—æ–°çš„è¾“å‡º

è®¡ç®—é‡: Step 11 = 100%, Step 12 â‰ˆ 2%
```

### ğŸ”´ é‡è¦å‘ç°ï¼šcache[0-50] å…¶å®æ²¡ç”¨ï¼

ä½ çš„é—®é¢˜é—®å¾—éå¸¸å¥½ï¼è®©æˆ‘ä»¬ä»”ç»†åˆ†æç¼“å­˜æ­¥éª¤çš„æ‰§è¡Œæµç¨‹ï¼š

```
Step 12 çš„çœŸå®æ‰§è¡Œæµç¨‹ï¼ˆä½¿ç”¨ç¼“å­˜ï¼‰:

  latent_12 ä¼ å…¥ Block 0
       â†“
  Block 0: is_skip(0) = True â†’ è¿”å› cache[0]ï¼Œå¿½ç•¥ latent_12
       â†“ (è¿”å›å€¼ cache[0] ä¼ ç»™ Block 1)
  Block 1: is_skip(1) = True â†’ è¿”å› cache[1]ï¼Œå¿½ç•¥è¾“å…¥çš„ cache[0]  â† æ²¡ç”¨ï¼
       â†“ (è¿”å›å€¼ cache[1] ä¼ ç»™ Block 2)
  Block 2: is_skip(2) = True â†’ è¿”å› cache[2]ï¼Œå¿½ç•¥è¾“å…¥çš„ cache[1]  â† æ²¡ç”¨ï¼
       â†“
      ...
       â†“
  Block 51: is_skip(51) = True â†’ è¿”å› cache[51]ï¼Œå¿½ç•¥è¾“å…¥çš„ cache[50] â† æ²¡ç”¨ï¼
       â†“ (è¿”å›å€¼ cache[51] ä¼ ç»™ Block 52)
  Block 52: is_skip(52) = False â†’ æ­£å¸¸è®¡ç®—ï¼Œä½¿ç”¨ cache[51] ä½œä¸ºè¾“å…¥  â† å”¯ä¸€è¢«ä½¿ç”¨çš„ï¼
       â†“
  noise_pred_12
```

**ç»“è®º**ï¼š
- **cache[0] - cache[50] å®Œå…¨æ²¡æœ‰è¢«ä½¿ç”¨ï¼**
- **åªæœ‰ cache[51]ï¼ˆBlock 51 çš„è¾“å‡ºï¼‰è¢« Block 52 çœŸæ­£ä½¿ç”¨**

### ä¸ºä»€ä¹ˆè¿˜è¦ç¼“å­˜æ‰€æœ‰ blockï¼Ÿ

è¿™æ˜¯ angelslim å®ç°çš„è®¾è®¡é€‰æ‹©ï¼ŒåŸå› å¯èƒ½æ˜¯ï¼š

1. **ä»£ç ç®€æ´æ€§**ï¼šæ‰€æœ‰ block ç”¨ç»Ÿä¸€çš„ wrap é€»è¾‘
2. **æ”¯æŒå¤æ‚ç­–ç•¥**ï¼šå¦‚æœ `no_cache_block_id` åŒ…å«å¤šä¸ª blockï¼ˆæ¯”å¦‚ Block 26 å’Œ Block 52 éƒ½ä¸è·³è¿‡ï¼‰ï¼Œé‚£éœ€è¦ cache[25] å’Œ cache[51]
3. **å†…å­˜æ¢ä»£ç å¤æ‚åº¦**ï¼š52 ä¸ª tensor çš„å†…å­˜å¼€é”€æ¢å–æ›´ç®€å•çš„å®ç°

### æ›´ç²¾ç¡®çš„è¯´æ³•

å®é™…ä¸Šï¼ŒDeepCache çš„**çœŸæ­£å·¥ä½œåŸç†**æ˜¯ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     DeepCache çœŸæ­£åšçš„äº‹æƒ…                                   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                             â”‚
â”‚  1. åœ¨"å¡«å……ç¼“å­˜"æ­¥éª¤ï¼ˆå¦‚ step 11ï¼‰ï¼š                                         â”‚
â”‚     - æ­£å¸¸æ‰§è¡Œæ‰€æœ‰ 53 ä¸ª block                                              â”‚
â”‚     - ä¿å­˜ Block 51 çš„è¾“å‡ºåˆ° cache[51]                                      â”‚
â”‚     - (å…¶ä»– cache ä¿å­˜äº†ä½†æ²¡ç”¨)                                             â”‚
â”‚                                                                             â”‚
â”‚  2. åœ¨"ä½¿ç”¨ç¼“å­˜"æ­¥éª¤ï¼ˆå¦‚ step 12, 13, 14ï¼‰ï¼š                                 â”‚
â”‚     - Block 0-51 å…¨éƒ¨è·³è¿‡ï¼ˆç›´æ¥è¿”å›ç¼“å­˜ï¼Œè¾“å…¥è¢«å¿½ç•¥ï¼‰                        â”‚
â”‚     - åªæœ‰ Block 52 æ­£å¸¸æ‰§è¡Œï¼Œè¾“å…¥ = cache[51]                              â”‚
â”‚                                                                             â”‚
â”‚  æ•ˆæœï¼š                                                                      â”‚
â”‚     - 52 å±‚è®¡ç®—å˜æˆ 1 å±‚è®¡ç®—                                                â”‚
â”‚     - åŠ é€Ÿ 52x... ä½†æœ‰å›ºå®šå¼€é”€ï¼Œå®é™…çº¦ 1.83x                                â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ¯ ä¸€å¥è¯æ€»ç»“ DeepCache æ ¸å¿ƒæ€æƒ³

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                                             â”‚
â”‚     ç”¨ç›¸åŒçš„"ä¸­é—´ç‰¹å¾"ï¼ˆcache[51]ï¼‰è®¡ç®— 4 æ¬¡ä¸åŒ timestep çš„å™ªå£°é¢„æµ‹          â”‚
â”‚                                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**è¯¦ç»†æ¥è¯´**ï¼š

```
Step 11: latent_11 â†’ [Block 0-51 æ­£å¸¸è®¡ç®—] â†’ out_51 â†’ ä¿å­˜åˆ° cache[51]
                                                â†“
         cache[51] + timestep_11 â†’ Block_52 â†’ noise_pred_11

Step 12: cache[51] + timestep_12 â†’ Block_52 â†’ noise_pred_12  (åªç®— Block 52!)
Step 13: cache[51] + timestep_13 â†’ Block_52 â†’ noise_pred_13  (åªç®— Block 52!)
Step 14: cache[51] + timestep_14 â†’ Block_52 â†’ noise_pred_14  (åªç®— Block 52!)

Step 15: latent_15 â†’ [Block 0-51 æ­£å¸¸è®¡ç®—] â†’ out_51 â†’ æ›´æ–° cache[51]
                                                â†“
         cache[51] + timestep_15 â†’ Block_52 â†’ noise_pred_15

Step 16: cache[51] + timestep_16 â†’ Block_52 â†’ noise_pred_16  (åªç®— Block 52!)
...
```

**å…³é”®æ´å¯Ÿ**ï¼š
- Block 52 çš„è¾“å…¥ = cache[51] + timestep_t
- **cache[51] å›ºå®š 4 æ­¥ä¸å˜ï¼Œåªæœ‰ timestep åœ¨å˜**
- æ‰€ä»¥ 52 å±‚è®¡ç®—å˜æˆ 1 å±‚è®¡ç®—
- æ¯ç®— 1 æ¬¡å®Œæ•´çš„ï¼Œçœä¸‹ 3 æ¬¡ï¼

### æ ¸å¿ƒå‡è®¾

```
å‡è®¾ï¼šBlock_51(Block_50(...Block_0(latent_t)))
        â‰ˆ
      Block_51(Block_50(...Block_0(latent_{t-1})))

å«ä¹‰ï¼šä¸åŒ latent ç»è¿‡ 51 å±‚ block åï¼Œè¾“å‡ºå‡ ä¹ç›¸åŒ

æ‰€ä»¥ç”¨ step 11 è®¡ç®—çš„ cache[51] ä»£æ›¿ step 12/13/14 çš„è®¡ç®—ç»“æœ
```

è¿™ä¸ªå‡è®¾æˆç«‹çš„åŸå› ï¼š
1. æ‰©æ•£æ¨¡å‹çš„ scheduler è®¾è®¡ä½¿ç›¸é‚» latent å˜åŒ–å¾ˆå°
2. Transformer æ˜¯è¿ç»­æ˜ å°„ï¼Œè¾“å…¥å°å˜åŒ– â†’ è¾“å‡ºå°å˜åŒ–
3. 4 æ­¥é—´éš”è¶³å¤Ÿå°ï¼Œè¯¯å·®å¯å¿½ç•¥

### ä¸ºä»€ä¹ˆæœ€åä¸€å±‚ä¸è·³è¿‡ï¼Ÿ

`no_cache_block_id = 53` çš„å«ä¹‰æ˜¯ Block 52ï¼ˆç¬¬ 53 å±‚ï¼Œç´¢å¼•ä» 0 å¼€å§‹ï¼‰æ°¸è¿œä¸è·³è¿‡ï¼š

```
Block 52 (æœ€åä¸€å±‚) çš„ä½œç”¨:
â”œâ”€â”€ èšåˆæ‰€æœ‰å‰é¢å±‚çš„ç‰¹å¾
â”œâ”€â”€ ç”Ÿæˆæœ€ç»ˆçš„ noise prediction
â””â”€â”€ è¿™ä¸€å±‚è¾“å‡ºçš„å¾®å°å˜åŒ–ä¼šç›´æ¥å½±å“å»å™ªè´¨é‡

ç»“è®º: æœ€åä¸€å±‚å¿…é¡»è®¡ç®—ï¼Œç¡®ä¿æ¯ä¸€æ­¥çš„ noise_pred éƒ½æ˜¯ç²¾ç¡®çš„
```

## æºç åˆ†æ

### DeepCacheHelper æ ¸å¿ƒä»£ç 

```python
class DeepCacheHelper(CacheHelper):
    """
    DeepCache çš„æ ¸å¿ƒå®ç°
    """
    
    def __init__(self, double_blocks, no_cache_steps, no_cache_block_id):
        # double_blocks: HunyuanVideo çš„ 53 ä¸ª transformer block
        # no_cache_steps: ä¸ä½¿ç”¨ç¼“å­˜çš„æ­¥éª¤é›†åˆ {0,1,2,...,10, 11,15,19,..., 45,46,47,48,49}
        # no_cache_block_id: {"double_blocks": {52}} - æœ€åä¸€å±‚ä¸è·³è¿‡
        ...
    
    def is_skip(self, block_id, blocktype):
        """åˆ¤æ–­å½“å‰ block æ˜¯å¦åº”è¯¥è·³è¿‡è®¡ç®—"""
        
        # 1. å¦‚æœå½“å‰æ­¥éª¤åœ¨ no_cache_steps ä¸­ï¼Œä¸è·³è¿‡ï¼ˆæ­£å¸¸è®¡ç®—ï¼‰
        if self.cur_timestep in self.no_cache_steps:
            return False
        
        # 2. å¦‚æœå½“å‰ block åœ¨ no_cache_block_id ä¸­ï¼Œä¸è·³è¿‡
        if block_id in self.no_cache_block_id[blocktype]:
            return False
        
        # 3. å…¶ä»–æƒ…å†µï¼šè·³è¿‡è®¡ç®—ï¼Œä½¿ç”¨ç¼“å­˜
        return True
    
    def wrap_block_forward(self, block, block_id, blocktype):
        """åŒ…è£… block çš„ forward æ–¹æ³•"""
        
        original_forward = block.forward  # ä¿å­˜åŸå§‹æ–¹æ³•
        
        def wrapped_forward(*args, **kwargs):
            skip = self.is_skip(block_id, blocktype)
            
            if skip:
                # è·³è¿‡è®¡ç®—ï¼Œç›´æ¥è¿”å›ç¼“å­˜
                return self.cached_output[(blocktype, block_id)]
            else:
                # æ­£å¸¸è®¡ç®—ï¼Œå¹¶ç¼“å­˜ç»“æœ
                result = original_forward(*args, **kwargs)
                self.cached_output[(blocktype, block_id)] = result
                return result
        
        block.forward = wrapped_forward  # æ›¿æ¢ forward æ–¹æ³•
```

### å…³é”®æ–¹æ³•è°ƒç”¨æµç¨‹

```
1. åˆå§‹åŒ–æ—¶:
   cache_helper = DeepCacheHelper(transformer.double_blocks, ...)
   cache_helper.enable()  # åŒ…è£…æ‰€æœ‰ block çš„ forward æ–¹æ³•
   
2. æ¯æ­¥æ¨ç†å‰:
   cache_helper.cur_timestep = i  # è®¾ç½®å½“å‰æ­¥éª¤å·
   
3. Transformer forward æ—¶:
   for block in double_blocks:
       block.forward(...)  # è‡ªåŠ¨è§¦å‘ wrapped_forward
       
4. æ¨ç†ç»“æŸå:
   cache_helper.disable()  # è¿˜åŸåŸå§‹ forward æ–¹æ³•
```

## è®¡ç®—é‡åˆ†æ

### é»˜è®¤é…ç½®åˆ†æ

```python
# é…ç½®
total_steps = 50
cache_start_step = 11  # ä»ç¬¬ 11 æ­¥å¼€å§‹ä½¿ç”¨ç¼“å­˜
cache_end_step = 45    # åˆ°ç¬¬ 45 æ­¥ç»“æŸ
cache_step_interval = 4  # æ¯ 4 æ­¥ç¼“å­˜ä¸€æ¬¡

# è®¡ç®— no_cache_steps (ä¸ä½¿ç”¨ç¼“å­˜çš„æ­¥éª¤)
no_cache_steps = (
    list(range(0, 11)) +          # å‰ 11 æ­¥: [0,1,2,...,10] = 11 æ­¥
    list(range(11, 45, 4)) +      # ä¸­é—´æ¯éš”4æ­¥: [11,15,19,23,27,31,35,39,43] = 9 æ­¥  
    list(range(45, 50))           # å 5 æ­¥: [45,46,47,48,49] = 5 æ­¥
)
# = 11 + 9 + 5 = 25 æ­¥ æ­£å¸¸è®¡ç®—

# ä½¿ç”¨ç¼“å­˜çš„æ­¥éª¤ = 50 - 25 = 25 æ­¥ (è·³è¿‡å¤§éƒ¨åˆ†è®¡ç®—)
```

### åŠ é€Ÿæ•ˆæœåˆ†æ

| æ­¥éª¤ç±»å‹ | æ•°é‡ | æ¯æ­¥è®¡ç®—é‡ | æ¯æ­¥è€—æ—¶ |
|----------|------|-----------|----------|
| æ­£å¸¸è®¡ç®— | 25 æ­¥ | 100% (53 blocks) | ~5.2s |
| ç¼“å­˜åŠ é€Ÿ | 25 æ­¥ | ~2% (1 block) | ~0.1s |

**æ€»è€—æ—¶è®¡ç®—**ï¼š
- åŸå§‹: 50 Ã— 5.2s = 260s
- DeepCache: 25 Ã— 5.2s + 25 Ã— 0.1s â‰ˆ 130s + 2.5s â‰ˆ 132s
- ç†è®ºåŠ é€Ÿæ¯”: 260 / 132 â‰ˆ **1.97x**
- å®æµ‹åŠ é€Ÿæ¯”: 260 / 142 â‰ˆ **1.83x** ï¼ˆç•¥æœ‰å¼€é”€ï¼‰

## ä¸ºä»€ä¹ˆè´¨é‡æŸå¤±æå°ï¼Ÿ

### 1. æ‰©æ•£è¿‡ç¨‹çš„æ—¶é—´å¹³æ»‘æ€§

```
x_t â†’ x_{t-1} â†’ x_{t-2} â†’ ... â†’ x_0

æ¯ä¸€æ­¥çš„å˜åŒ–éƒ½å¾ˆå° (ç”± scheduler æ§åˆ¶)
å› æ­¤ä¸­é—´ç‰¹å¾çš„å˜åŒ–ä¹Ÿå¾ˆå°
```

### 2. ç­–ç•¥æ€§åœ°é€‰æ‹©ä¸ç¼“å­˜çš„æ­¥éª¤

```
å‰æœŸ (æ­¥éª¤ 0-10): ä¸ç¼“å­˜
â”œâ”€â”€ å™ªå£°æœ€å¤§ï¼Œå˜åŒ–æœ€å‰§çƒˆ
â”œâ”€â”€ ç»“æ„å’Œè¯­ä¹‰ä¿¡æ¯è¿˜åœ¨å½¢æˆ
â””â”€â”€ å¿…é¡»ç²¾ç¡®è®¡ç®—

ä¸­æœŸ (æ­¥éª¤ 11-44): é—´éš”ç¼“å­˜
â”œâ”€â”€ ç»“æ„å·²ç»ç¨³å®š
â”œâ”€â”€ æ¯ 4 æ­¥æ›´æ–°ä¸€æ¬¡ç¼“å­˜
â””â”€â”€ ç¼“å­˜æ­¥éª¤ç›´æ¥å¤ç”¨

åæœŸ (æ­¥éª¤ 45-49): ä¸ç¼“å­˜
â”œâ”€â”€ ç»†èŠ‚å’Œæ”¶æ•›é˜¶æ®µ
â”œâ”€â”€ éœ€è¦ç²¾ç¡®è®¡ç®—ç¡®ä¿æ”¶æ•›
â””â”€â”€ é¿å…æœ€ç»ˆè´¨é‡æŸå¤±
```

### 3. æœ€åä¸€å±‚æ°¸ä¸è·³è¿‡

```
Block 52 è´Ÿè´£ç”Ÿæˆ noise_pred
è¿™æ˜¯ scheduler çš„ç›´æ¥è¾“å…¥
å¿…é¡»ä¿è¯æ¯ä¸€æ­¥éƒ½ç²¾ç¡®è®¡ç®—
```

## ä¸å…¶ä»–åŠ é€Ÿæ–¹æ³•çš„å¯¹æ¯”

| æ–¹æ³• | åŸç† | åŠ é€Ÿæ¯” | è´¨é‡æŸå¤± | å†…å­˜å¼€é”€ |
|------|------|--------|----------|----------|
| **DeepCache** | å¤ç”¨ä¸­é—´å±‚ç¼“å­˜ | 1.83x | æå° | +ç¼“å­˜å†…å­˜ |
| SageAttention | INT8 é‡åŒ– Q/K | 1.6x | æ˜æ˜¾ | æ—  |
| Flash Attention | ä¼˜åŒ–å†…å­˜è®¿é—® | 1.0x (baseline) | æ—  | å‡å°‘ |
| Sparse Attention | ç¨€ç–æ³¨æ„åŠ› | 1.5-2x | å–å†³äºç¨€ç–åº¦ | å‡å°‘ |

## Mermaid æµç¨‹å›¾

### æ•´ä½“æµç¨‹

```mermaid
flowchart TD
    subgraph Init["åˆå§‹åŒ–é˜¶æ®µ"]
        A[åŠ è½½ Transformer] --> B[åˆ›å»º DeepCacheHelper]
        B --> C[åŒ…è£…æ‰€æœ‰ Block çš„ forward æ–¹æ³•]
    end
    
    subgraph Denoising["Denoising Loop (50 æ­¥)"]
        D[è®¾ç½® cur_timestep = i]
        D --> E{cur_timestep åœ¨ no_cache_steps?}
        E -->|æ˜¯| F[æ­£å¸¸è®¡ç®—æ‰€æœ‰ Block]
        E -->|å¦| G[å¤§éƒ¨åˆ† Block ä½¿ç”¨ç¼“å­˜]
        F --> H[ç¼“å­˜æ‰€æœ‰ Block è¾“å‡º]
        G --> I[åªè®¡ç®—æœ€åä¸€å±‚]
        H --> J[scheduler.step]
        I --> J
        J --> K{è¿˜æœ‰æ›´å¤šæ­¥?}
        K -->|æ˜¯| D
        K -->|å¦| L[å®Œæˆ]
    end
    
    Init --> Denoising
```

### å• Block ç¼“å­˜é€»è¾‘

```mermaid
flowchart LR
    subgraph WrappedForward["wrapped_forward()"]
        A[è¾“å…¥] --> B{is_skip?}
        B -->|True ä½¿ç”¨ç¼“å­˜| C[è¿”å› cached_output]
        B -->|False æ­£å¸¸è®¡ç®—| D[è°ƒç”¨ original_forward]
        D --> E[ä¿å­˜åˆ° cached_output]
        E --> F[è¿”å›ç»“æœ]
    end
```

## å®éªŒæ•°æ®

### æµ‹è¯•é…ç½®

```yaml
Hardware: NVIDIA H100 Ã— 8
Resolution: 720p (1280Ã—720)
Frames: 121 (çº¦ 5 ç§’ @24fps)
Steps: 50
Prompt: "A young woman with beautiful clear eyes and blonde hair..."

DeepCache é…ç½®:
  cache_start_step: 11
  cache_end_step: 45
  cache_step_interval: 4
  no_cache_block_id: 53 (æœ€åä¸€å±‚)
```

### æ€§èƒ½å¯¹æ¯”

| æŒ‡æ ‡ | Flash Attention 2 | DeepCache |
|------|-------------------|-----------|
| æ¯æ­¥è€—æ—¶ | 5.2s | 2.84s (å¹³å‡) |
| æ€»è€—æ—¶ | 260s | 142s |
| **åŠ é€Ÿæ¯”** | 1.0x | **1.83x** |
| æ˜¾å­˜å ç”¨ | 35GB | 35GB |

### è´¨é‡å¯¹æ¯”

å®æµ‹ç”Ÿæˆçš„è§†é¢‘ä¸åŸç‰ˆå‡ ä¹æ— æ³•åŒºåˆ†ï¼š
- ç”»é¢ç»†èŠ‚ä¿ç•™å®Œå¥½
- äººç‰©ä¸€è‡´æ€§è‰¯å¥½
- è¿åŠ¨æµç•…è‡ªç„¶
- èƒŒæ™¯å¤æ‚åº¦æ­£å¸¸

## ä½¿ç”¨å»ºè®®

### æ¨èé…ç½®

```bash
# æ—¥å¸¸ä½¿ç”¨ï¼ˆæ¨èï¼‰
bash run_stage2.sh --enable_cache

# ä¿å®ˆé…ç½®ï¼ˆæ›´é«˜è´¨é‡ï¼Œè¾ƒå°‘åŠ é€Ÿï¼‰
bash run_stage2.sh --enable_cache \
    --cache_start_step 15 \
    --cache_end_step 40 \
    --cache_step_interval 3

# æ¿€è¿›é…ç½®ï¼ˆæœ€å¤§åŠ é€Ÿï¼Œå¯èƒ½æœ‰è½»å¾®è´¨é‡æŸå¤±ï¼‰
bash run_stage2.sh --enable_cache \
    --cache_start_step 5 \
    --cache_end_step 48 \
    --cache_step_interval 5
```

### æ³¨æ„äº‹é¡¹

1. **å†…å­˜å¼€é”€**: ç¼“å­˜ 53 ä¸ª Block çš„è¾“å‡ºéœ€è¦é¢å¤–å†…å­˜ï¼ˆçº¦ 2-3GBï¼‰
2. **é¦–æ¬¡è¿è¡Œ**: ç¬¬ä¸€ä¸ªç¼“å­˜å‘¨æœŸéœ€è¦å®Œæ•´è®¡ç®—å¡«å……ç¼“å­˜
3. **ä¸å…¶ä»–åŠ é€Ÿç»„åˆ**: å¯ä¸ SageAttention ç»„åˆä½¿ç”¨ï¼Œä½†è´¨é‡å¯èƒ½ä¸‹é™

## å‚è€ƒèµ„æ–™

- [DeepCache åŸè®ºæ–‡](https://arxiv.org/abs/2312.00858)
- [angelslim åº“](https://github.com/Tencent/angelslim)
- [HunyuanVideo 1.5](https://github.com/Tencent-Hunyuan/HunyuanVideo-1.5)